---
title: "Differential cell-type-specific allelic imbalance with airpart"
author: 
  - name: Wancen Mu, Hirak Sarkar, Avi Srivastava, Kwangbom Choi, Rob Patro, Michael I. Love
date: "Feb 1, 2021"
abstract: |
  airpart is an R package that identifies subsets of genes 
  displaying differential allelic imbalance across cell types.
output: 
  html_document:
    toc: true
    toc_float: true 
    theme: united
    highlight: tango
vignette: |
  %\VignetteIndexEntry{Differential cell-type-specific allelic imbalance with airpart}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE)
```

# Download package

```{r}
library(devtools)
load_all()
# library(airpart)
```

# Overview of data

We will simulate some data using `makeSimulatedData` function provided
within the *airpart* package.

### Simulation set-up

Set up simulated example dataset has 3 gene clusters with differential allelic imbalance (DAI): 
* first cluster has pairs of cell types with same allelic ratio spanning from 1/10 to 9/10 (larger DAI)
* second cluster has balanced allelic ratio
* third cluster has pairs of cell types with same allelic ratio spanning from 7/10 to 9/10 (smaller DAI)

Below we specify:

* the "noisy" cell count is 1
* the normal cell count is 20
* 4 cell types
* 10 cells within each cell types
* 25 genes within each gene cluster
* overdispersion parameter in `rbetabinom` is 20

```{r}
suppressPackageStartupMessages(library(SummarizedExperiment))
p.vec <- rep(c(0.2,0.8,0.5,0.5,0.7,0.9),each=2)
se <- makeSimulatedData(mu1=1,mu2=5,nct=4,n=10,ngenecl=25,theta=20,ncl=3,p.vec=p.vec)
```

```{r}
rowData(se)[c(1,26,51),]
table(colData(se))
assays(se)[["ase"]][1:5,1:5]
```

# Create allelic ratio matrix

Here we add the pseudo count for gene clustering and visualization.

```{r}
se <- preprocess(se)
makeRatioHeatmap(se)
```

The true partition in the simulation is given by these underlying ratios:

```{r}
library(pheatmap)
anno_df <- data.frame(x=factor(1:length(p.vec)),row.names=paste0("ct",1:length(p.vec)))
pheatmap(unique(rowData(se)),
         color=colorRampPalette(c("blue","white","red"))(101),
         breaks=0:100/100,
         annotation_col=anno_df,
         cluster_rows=FALSE, cluster_cols=FALSE,
         show_colnames=FALSE, show_rownames=FALSE)
```

# Gene clustering

We provide two methods for gene clustering. 

* Gaussian Mixture modeling

This is the default method. The scatter plot is shown based on Top 2 PCs. And `plot=FALSE` can be used to avoid showing the plot. 


```{r}
se <- geneCluster(se, G=c(1:8))
metadata(se)$geneCluster
```

* Hierarchical clustering 

```{r}
se.hc <- geneCluster(se, method="hierarchical")
metadata(se)$geneCluster
```

# Running airpart

## Simple summary table of alleic ratio

Quickly look at the weighted mean of allelic ratio for each gene cluster. Identify the interested gene cluster. 

```{r, results = "asis"}
se <- summaryAllelicRatio(se)
metadata(se)$summary
```

Note that we recommend users only run `airpart` when the largest ordered allelic ratio difference > 0.05 for speed concerns. We find that the allelic ratio of most of the gene clusters in such cases (small absolute allelic ratio differences) won't provide enough evidence to detect differential allelic imbalance.
```{r}
summary <- metadata(se)$summary
sapply(1:length(summary), function(i){
  inst <- summary[[i]]
  inst_order <- inst[order(inst$weighted.mean),]
  max(diff(inst_order$weighted.mean)) > 0.05
})
```

## Modeling using fused lasso with binomial likelihood

```{r}
f <- ratio ~ p(x, pen = "gflasso") # formula for the GFL
se_sub <- fusedLasso(formula=f,model="binomial",se,genecluster=1,ncores=2,niter=2)
```

```{r, results="asis"}
knitr::kable(metadata(se_sub)$partition, row.names=FALSE)
```

Here `ncores` is the number of CPU used for parallelization. One can
specify `niter=5` when the `cts` weighted allelic ratio difference
is smaller than 0.1, in order to provide additional estimator
robustness.

### Consensus partition

If you run `niter` > 1, please use a consensus partition to derive the
final partition.

```{r, results='asis', collapse=TRUE}
se_sub <- consensusPart(se_sub)
knitr::kable(metadata(se_sub)$partition, row.names=FALSE)
```

## Modeling using pairwise Mann Whitney Wilcoxon extension

```{r}
thrs <- 10^seq(from=-2,to=-0.4,by=0.1)
se_sub <- wilcoxExt(se, genecluster=1, threshold=thrs)
knitr::kable(metadata(se_sub)$partition, row.names=FALSE)
```

## Calculating allelic Ratio estimator by betabinomial 

### Confidence interval with normal approximation

```{r, warning=FALSE, results="asis"}
# TODO gives error, see line 72 in betabinom.R
se_sub <- allelicRatio(se_sub)
knitr::kable(metadata(se_sub)$estimator, row.names=FALSE)
```

### Confidence interval with bootstrap

```{r, warning=FALSE, results="asis"}
se_sub <- allelicRatio(se_sub, method="bootstrap", R=200, ncores=4)
```

# Displaying results on heatmap

To demonstrate showing partition results on a heatmap, let's make a more
complex simulation:

The basic steps are:

* make total, ratio, ratio_pseudo matrix
* genecluster [check]
* make data frame 
* add partition information to cell level information to make plots

```{r}
nct <- 8
p.vec <- ( rep(c(
    seq(from=-4,to=4,length.out=nct/2),
    rep(0,nct/2),
    seq(from=2,to=4,length.out=nct/2)
  ), each=2) + 5 ) / 10
se <- makeSimulatedData(mu1=3,mu2=20,nct=nct,n=10,ngenecl=25,theta=20,ncl=3,p.vec=p.vec)
se <- preprocess(se)
estDisp(se)
makeRatioHeatmap(se)
se <- geneCluster(se, G=c(1:8))
se <- summaryAllelicRatio(se) # identify interesting gene cluster

f <- ratio ~ p(x, pen = "gflasso") # formula for the GFL
se_sub <- fusedLasso(formula=f,model="binomial",se,genecluster=1,ncores=2,niter=2) 
se_sub <- consensusPart(se_sub)
thrs <- 10^seq(from=-2,to=-0.4,by=0.1)
se_sub <- wilcoxExt(se,genecluster=1,threshold=thrs) # alternative
se_sub <- allelicRatio(se_sub)
makeForest(se_sub)
makeBoxplot(se_sub)
makeRatioHeatmap(se_sub)
```

# Session Info

```{r}
sessionInfo()
```
